<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>藥物衛教查詢</title>

<style>
  .tabs{
  display:flex;
  gap:10px;
  margin: 10px 0 16px;
}

.tab{
  flex:1;
  padding: 12px 10px;
  border-radius: 999px;
  border: 1px solid #ddd;
  background: #fff;
  font-size: 16px;
  cursor: pointer;
}

.tab.active{
  border-color: #007aff;
  font-weight: 600;
}
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 16px;
    background: #f5f5f5;
  }
  h1 { font-size: 20px; margin-bottom: 12px; }

  .card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }

  input {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 10px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  .label {
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
  }

  .list {
    max-height: 300px;
    overflow-y: auto;
    border-top: 1px solid #eee;
    margin-top: 8px;
  }

  .item {
    padding: 12px 4px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }

  .item:hover {
    background: #f0f0f0;
  }
  
  .acWrap{ position: relative; }

  .acList{
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 6px);
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    max-height: 260px;
    overflow-y: auto;
    z-index: 999;
  }

  .acItem{
    padding: 12px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }

  .acItem:last-child{ border-bottom: 0; }

  .acItem .main{ font-size: 16px; }
  .acItem .sub{ font-size: 12px; color: #666; margin-top: 2px; }

  .acItem:active{ background: #f2f2f2; }
  mark{ background: transparent; font-weight: 700; }

</style>
</head>

<body>

<h1>藥物衛教查詢</h1>

<div class="tabs" id="catTabs">
  <button class="tab" data-cat="pen">筆針</button>
  <button class="tab" data-cat="inhaler">吸入器</button>
  <button class="tab" data-cat="other">其他</button>
</div>
  
<div class="card">
  <div class="label">5 碼代碼（輸入滿 5 碼自動跳）</div>
  <input id="codeInput" inputmode="numeric" pattern="[0-9]*" placeholder="例如：12345" />
</div>

<div class="card" id="recentCard" style="display:none;">
  <div class="label">最近使用</div>
  <div id="recentList" class="list"></div>
</div>
  
<div class="card">
  <div class="label">藥理分類（可輸入搜尋）</div>
  <input id="classInput" placeholder="輸入藥理分類關鍵字" />
</div>

<div class="card">
  <div class="label">藥物品項 / 商品名（可輸入搜尋）</div>
   <div class="acWrap">
    <input id="itemInput" autocomplete="off" autocapitalize="off" spellcheck="false"
           placeholder="輸入藥名、學名、關鍵字（例：tou）" />
    <div id="acList" class="acList" style="display:none;"></div>
  </div>
  
  <div id="resultList" class="list"></div>
</div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbwe_lMyfnS8EmQH56y3xeybETs9kVXMwKCZ2e-TgmuVlbl1wvqZrslsNvV5O191ekbVpg/exec';

const params = new URLSearchParams(location.search);
const category = params.get('category') || 'inhaler';

const codeInput = document.getElementById('codeInput');
const classInput = document.getElementById('classInput');
const itemInput  = document.getElementById('itemInput');
const resultList = document.getElementById('resultList');
const acList = document.getElementById('acList');

let allItems = [];

// ===== 分類切換 Tabs =====
initCategoryTabs_();

function initCategoryTabs_() {
  const tabs = document.querySelectorAll('#catTabs .tab');
  tabs.forEach(btn => {
    const cat = btn.dataset.cat;
    if (cat === category) btn.classList.add('active');
    btn.addEventListener('click', () => {
      if (cat === category) return;
      location.href = `?category=${encodeURIComponent(cat)}`;
    });
  });
}

// ===== 載入資料 =====
fetch(`${API_BASE}?action=list&category=${encodeURIComponent(category)}`)
  .then(r => r.json())
  .then(data => {
    allItems = data || [];
    renderList(allItems);
  })
  .catch(err => {
    console.log('list fetch failed', err);
    resultList.innerHTML = '<div class="item">清單載入失敗：請確認 API_BASE / 權限設定</div>';
  });

// ===== 5 碼自動跳 =====
codeInput.addEventListener('input', e => {
  const v = String(e.target.value || '').trim();
  if (v.length === 5) location.href = `item.html?code=${encodeURIComponent(v)}`;
});

// ===== 篩選 =====
classInput.addEventListener('input', filterItems);

function filterItems() {
  const c = (classInput.value || '').toLowerCase();
  const q = (itemInput.value || '').toLowerCase();

  const filtered = allItems.filter(it =>
    (!c || (it.pharm_class || '').toLowerCase().includes(c)) &&
    (!q || (
      (it.item_name || '').toLowerCase().includes(q) ||
      (it.brand_name || '').toLowerCase().includes(q) ||
      (it.generic_name || '').toLowerCase().includes(q) ||
      (it.tags || '').toLowerCase().includes(q)
    ))
  );
  renderList(filtered);
}

// ===== 顯示清單 =====
function renderList(list) {
  resultList.innerHTML = '';
  (list || []).forEach(it => {
    const div = document.createElement('div');
    div.className = 'item';
    div.textContent = `${it.item_name || '(未命名)'}（${it.brand_name || ''}）`;
    div.onclick = () => location.href = `item.html?code=${encodeURIComponent(it.code5)}`;
    resultList.appendChild(div);
  });
}

itemInput.addEventListener('input', onItemTyping_);
itemInput.addEventListener('focus', onItemTyping_);

document.addEventListener('click', (e) => {
  // 點到輸入框或下拉本身不關
  if (e.target === itemInput || acList.contains(e.target)) return;
  hideAc_();
});

function onItemTyping_(){
  const q = (itemInput.value || '').trim().toLowerCase();
  // 沒輸入就先不顯示
  if (!q) { hideAc_(); return; }

  // 先套用藥理分類過濾（如果你有在用）
  const c = (classInput.value || '').trim().toLowerCase();

  const hits = allItems
    .filter(it => {
      if (c && !(it.pharm_class || '').toLowerCase().includes(c)) return false;

      const brand = (it.brand_name || '').toLowerCase();
      const generic = (it.generic_name || '').toLowerCase();
      const item = (it.item_name || '').toLowerCase();
      const tags = (it.tags || '').toLowerCase();
      return brand.includes(q) || generic.includes(q) || item.includes(q) || tags.includes(q);
    })
    .slice(0, 12); // 最多顯示 12 筆（手機不會太長）

  renderAc_(hits, q);
}

function renderAc_(list, q){
  if (!list.length) {
    acList.innerHTML = `<div class="acItem"><div class="main">找不到相符項目</div><div class="sub">請換關鍵字</div></div>`;
    acList.style.display = 'block';
    return;
  }

  acList.innerHTML = '';
  list.forEach(it => {
    const div = document.createElement('div');
    div.className = 'acItem';

    const brand = it.brand_name || it.item_name || '(未命名)';
    const generic = it.generic_name || '';
    const code5 = it.code5 || '';

    div.innerHTML = `
      <div class="main">${highlight_(brand, q)}</div>
      <div class="sub">${generic ? generic + ' · ' : ''}代碼 ${code5}</div>
    `;

    // 用 mousedown/touchstart 可避免點選時 input blur 先觸發把清單關掉
    div.addEventListener('mousedown', (ev) => {
      ev.preventDefault();
      goItem_(code5);
    });
    div.addEventListener('touchstart', (ev) => {
      ev.preventDefault();
      goItem_(code5);
    }, {passive:false});

    acList.appendChild(div);
  });

  acList.style.display = 'block';
}

function hideAc_(){
  acList.style.display = 'none';
}

function goItem_(code5){
  hideAc_();
  location.href = `item.html?code=${encodeURIComponent(code5)}`;
}

function highlight_(text, q){
  const t = String(text || '');
  const idx = t.toLowerCase().indexOf(q);
  if (idx < 0) return escapeHtml_(t);
  const a = t.slice(0, idx);
  const b = t.slice(idx, idx + q.length);
  const c = t.slice(idx + q.length);
  return `${escapeHtml_(a)}<mark>${escapeHtml_(b)}</mark>${escapeHtml_(c)}`;
}

function escapeHtml_(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}  
  
// ===== 最近使用（只顯示目前分類）=====
renderRecent_();

function renderRecent_() {
  try {
    const key = 'pharma_recent_v1';
    const list = JSON.parse(localStorage.getItem(key) || '[]');

    const filtered = list.filter(it => !it.category || it.category === category);

    const card = document.getElementById('recentCard');
    const box  = document.getElementById('recentList');

    if (!filtered.length) {
      card.style.display = 'none';
      return;
    }

    card.style.display = 'block';
    box.innerHTML = '';

    filtered.forEach(it => {
      const div = document.createElement('div');
      div.className = 'item';
      const name = it.item_name || '(未命名)';
      const brand = it.brand_name ? `（${it.brand_name}）` : '';
      div.textContent = `${name}${brand}`;
      div.onclick = () => location.href = `item.html?code=${encodeURIComponent(it.code5)}`;
      box.appendChild(div);
    });
  } catch (err) {
    document.getElementById('recentCard').style.display = 'none';
  }
}
</script>

</body>
</html>
