<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è—¥ç‰©è³‡è¨Š</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin: 0;
  padding: 16px;
  background: #f5f5f5;
}
.card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
h2 { margin-top: 0; }
.video {
  margin-top: 12px;
}
button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  background: #007aff;
  color: white;
  font-size: 16px;
}

.topbar{
  display:flex;
  gap:10px;
  margin-bottom: 12px;
}
.topbar button{
  flex:1;
  padding: 12px 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
  background: white;
  color: #111;
  font-size: 16px;
  cursor: pointer;
}
  
details.card { padding: 0; overflow: hidden; }
details.card > summary{
  list-style: none;
  cursor: pointer;
  padding: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
details.card > summary::-webkit-details-marker { display: none; }
details.card > summary::after{
  content: "â–¾";
  opacity: .7;
}
details.card[open] > summary::after{
  content: "â–´";
}
details.card .content{
  padding: 0 16px 16px;
  white-space: normal;
  line-height: 1.6;
}
.badgeRow{ display:flex; flex-wrap: wrap; gap:8px; }
.badge{
  display:inline-block;
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 999px;
  font-size: 13px;
  background: #fff;
}
  
</style>
</head>

<body>

<div id="content"></div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbwe_lMyfnS8EmQH56y3xeybETs9kVXMwKCZ2e-TgmuVlbl1wvqZrslsNvV5O191ekbVpg/exec';

const code = new URLSearchParams(location.search).get('code');

fetch(`${API_BASE}?action=item&code5=${encodeURIComponent(code || '')}`)
  .then(r => r.json())
  .then(d => {
  saveRecent_(d);
  console.log('recent_saved', localStorage.getItem('pharma_recent_v1'));
  render(d);
 });

function render(d) {
  const el = document.getElementById('content');

  const safe = (s) => escapeHtml_(String(s || ''));
  const nl2br = (s) => safe(s).replace(/\n/g, '<br>');
  const has = (v) => String(v || '').trim().length > 0;

  const tagsHtml = has(d.tags)
    ? String(d.tags).split(/[,ï¼Œ\n]/).map(t => t.trim()).filter(Boolean)
        .map(t => `<span class="badge">${safe(t)}</span>`).join('')
    : '';

  el.innerHTML = `
    <div class="topbar">
      <button onclick="goBack_()">â†©ï¸ è¿”å›</button>
      <button onclick="goHome_()">ğŸ  å›é¦–é </button>
    </div>

    <div class="card">
      <h2>${safe(d.brand_name)}</h2>
      <div>${safe(d.generic_name)}</div>
      <div>ä»£ç¢¼ï¼š${safe(d.code5)}</div>
      ${has(d.item_name) ? `<div style="margin-top:8px;opacity:.9">${safe(d.item_name)}</div>` : ''}
      ${tagsHtml ? `<div class="badgeRow" style="margin-top:12px">${tagsHtml}</div>` : ''}
    </div>

    ${section_('è¡›æ•™èªªæ˜', d.counsel_text)}
    ${section_('é©æ‡‰ç—‡èˆ‡åŠ‘é‡', d.indication_dose)}
    ${section_('æ³¨æ„äº‹é …æ¸…å–®', d.safety_checklist)}
    ${section_('å¸¸è¦‹å•ç­”', d.patient_qa)}
    ${videoSection_('è¡›æ•™å½±ç‰‡', d.video_url)}
  `;

  function section_(title, text){
    if (!has(text)) return '';
    return `
      <details class="card" open>
        <summary>${safe(title)}</summary>
        <div class="content">${nl2br(text)}</div>
      </details>
    `;
  }

  function videoSection_(title, urls){
    if (!has(urls)) return '';
    const parts = String(urls).split(',').map(s => s.trim()).filter(Boolean);
    if (!parts.length) return '';
    const buttons = parts.map((url, i) => {
      const vid = extractYouTubeId_(url);
      if (!vid) return '';
      return `
        <div style="margin-top:${i===0?0:12}px">
          <button onclick="this.outerHTML='<iframe width=100% height=215 src=https://www.youtube.com/embed/${vid} allowfullscreen></iframe>'">
            â–¶ æ’­æ”¾è¡›æ•™å½±ç‰‡ ${parts.length>1 ? (i+1) : ''}
          </button>
        </div>
      `;
    }).join('');
    return `
      <details class="card">
        <summary>${safe(title)}</summary>
        <div class="content">${buttons || 'ï¼ˆç„¡å¯ç”¨å½±ç‰‡é€£çµï¼‰'}</div>
      </details>
    `;
  }
}

  function extractYouTubeId_(url) {
  try {
    const u = new URL(url.trim());
    // youtu.be/VIDEOID
    if (u.hostname.includes('youtu.be')) {
      return u.pathname.replace('/', '');
    }
    // youtube.com/watch?v=VIDEOID
    const v = u.searchParams.get('v');
    if (v) return v;
    // youtube.com/embed/VIDEOID
    const m = u.pathname.match(/\/embed\/([^\/\?]+)/);
    if (m && m[1]) return m[1];
    return '';
  } catch (e) {
    return '';
  }
}

  function saveRecent_(d) {
  try {
    const key = 'pharma_recent_v1';
    const list = JSON.parse(localStorage.getItem(key) || '[]');

    const item = {
      code5: String(d.code5 || ''),
      item_name: d.item_name || '',
      brand_name: d.brand_name || '',
      category: d.category || ''
    };

    // ç§»é™¤åŒ code5 èˆŠé …ç›®ï¼ˆé¿å…é‡è¤‡ï¼‰
    const next = [item, ...list.filter(x => String(x.code5) !== item.code5)]
      .slice(0, 5); // æœ€å¤šç•™ 5 ç­†

    localStorage.setItem(key, JSON.stringify(next));
    console.log('saveRecent_ ok', next);
  } catch (err) {
    // localStorage å¤±æ•—å°±å¿½ç•¥ï¼ˆä¸å½±éŸ¿é é¢ï¼‰
  }
}

  function goBack_(){
  if (history.length > 1) history.back();
  else location.href = 'index.html';
}

  function goHome_(){
    location.href = 'index.html';
}

function escapeHtml_(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
  
</script>

</body>
</html>
